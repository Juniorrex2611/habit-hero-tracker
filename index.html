<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Hero Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Lighter, modern background */
            color: #1f2937;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08); /* Stronger, softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s; /* Added subtle hover effect */
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .check-btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .checked {
            background-color: #10b981 !important; /* Teal for success */
            color: white !important;
            cursor: default !important;
            box-shadow: none;
        }
        .not-checked {
            background-color: #4f46e5; /* Indigo for primary action */
            color: white;
        }
        .not-checked:hover {
            opacity: 1;
            background-color: #6366f1; /* Lighter Indigo on hover */
            transform: translateY(-2px);
        }
        .badge-icon {
            filter: grayscale(100%);
            opacity: 0.4;
            transition: all 0.3s ease-in-out;
            cursor: default;
        }
        .badge-icon.earned {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
            text-shadow: 0 0 8px rgba(255, 204, 0, 0.7);
        }
        .cheat-meal-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f87171 !important;
        }

        /* Roadmap Styles */
        .roadmap-track {
            height: 4px;
            background: linear-gradient(90deg, #d1d5db 0%, #a1a1aa 100%); /* Subtle gradient background for the path */
            position: absolute;
            top: 55%; /* Adjusted for better centering */
            transform: translateY(-50%);
            left: 0;
            right: 0;
            z-index: 0;
        }
        .day-stop-wrapper {
            position: relative;
            z-index: 10;
            padding: 0 4px;
        }
        .day-stop {
            min-width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #e5e7eb; /* Gray for incomplete/future/missed */
            transition: all 0.3s;
            flex-shrink: 0;
            border: 3px solid white; /* White border for lift effect */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer; /* Indicates clickability */
        }
        .day-stop.completed {
            background-color: #0d9488; /* Teal for full completion */
        }
        .day-stop.partial {
            background-color: #f59e0b; /* Amber/Orange for partial completion */
        }
        .day-stop.today {
            border: 3px solid #3b82f6; /* Blue border for today */
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        /* Modal General Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 400px;
        }
        .toggle-switch {
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.4s;
        }
        .toggle-switch.checked {
            background-color: #10b981;
        }
        .toggle-switch::after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: 0.4s;
        }
        .toggle-switch.checked::after {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-xl mx-auto">
        
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-2 text-gray-800 flex items-center justify-center">
            <span class="text-yellow-500 text-6xl mr-3 transform -translate-y-1">üëë</span>
            Habit Hero
            <span class="text-yellow-500 text-6xl ml-3 transform -translate-y-1">üëë</span>
        </h1>
        <p id="welcome-message" class="text-center text-gray-500 mb-8">Gamifying your consistency, one goal at a time.</p>

        
        <div id="stats-container" class="grid grid-cols-3 gap-4 mb-8">
            <div class="card text-center bg-yellow-50 shadow-md p-3">
                <p id="total-points" class="text-3xl font-extrabold text-yellow-600">0</p>
                <p id="total-points-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Points</p>
            </div>
            <div class="card text-center bg-indigo-50 shadow-md p-3">
                <p id="current-level" class="text-3xl font-extrabold text-indigo-600">1</p>
                <p id="current-level-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Level</p>
            </div>
            <div class="card text-center bg-red-50 shadow-md p-3">
                <p id="current-streak" class="text-3xl font-extrabold text-red-600">0</p>
                <p id="current-streak-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Streak üî•</p>
            </div>
        </div>

        <!-- PROGRESS BAR SECTION -->
        <div class="card p-3 mb-8">
            <div class="flex justify-between items-center mb-1">
                <p class="text-sm font-semibold text-gray-700">Progress to Next Level (Level <span id="next-level-display">2</span>)</p>
                <p class="text-xs font-medium text-indigo-600"><span id="points-current-in-level">0</span> / 50 Pts</p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="level-progress-bar" class="h-2.5 rounded-full bg-indigo-500" style="width: 0%"></div>
            </div>
        </div>
        <!-- END PROGRESS BAR SECTION -->

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                <span class="mr-2 text-teal-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14V4a2 2 0 0 0-4 0v10a2 2 0 0 1-2 2v6l2-1 2 1 2-1 2 1V8a2 2 0 0 0-2-2z"/></svg>
                </span>
                Your Habit Journey üó∫Ô∏è
            </h2>
            <div class="overflow-x-scroll pb-4 relative">
                
                <div class="roadmap-track absolute"></div> 
                <div id="roadmap-container" class="flex items-center space-x-2 relative z-10">
                    <!-- Roadmap items generated here -->
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center">Click a dot to edit a past day's status.</p>
        </div>
        
        
        <div class="card bg-purple-100 border-purple-300 border shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-purple-700 flex items-center">
                <span class="mr-2 text-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s2-4 5-4 5 4 5 4 2-4 5-4 5 4 5 4M4 17h16"/></svg>
                </span>
                Cheat Meal Rewards üçï
            </h2>
            <div class="flex items-center justify-between">
                <div>
                    <p id="cheat-meals-title" class="text-gray-700 text-lg font-semibold">Earned Tokens:</p>
                    <p id="cheat-meals-earned" class="text-5xl font-extrabold text-purple-600 mt-1">0</p>
                    <p id="snacks-needed-text" class="text-xs text-gray-500 mt-2">Next token in <span id="snacks-to-next-reward">5</span> snacks.</p>
                </div>
                <button id="use-cheat-meal" disabled
                        class="cheat-meal-btn px-6 py-3 bg-red-600 text-white font-bold rounded-full text-base hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400 shadow-md transition duration-150 ease-in-out">
                    Claim Reward!
                </button>
            </div>
        </div>


        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                <span class="mr-2 text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15 6L19 7L16 11L17 15L12 13L7 15L8 11L5 7L9 6L12 2z"/></svg>
                </span>
                Achievements üèÖ
            </h2>
            <div id="badges-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-2 justify-items-center">
                
            </div>
        </div>

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Today's Focus</h2>
            <div class="space-y-4">
                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-indigo-600">üí™</span>
                        <div>
                            <p class="font-semibold text-lg">Workout</p>
                            <p class="text-sm text-gray-500">+10 Points</p>
                        </div>
                    </div>
                    <button id="check-workout"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>

                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-teal-600">üçé</span>
                        <div>
                            <p class="font-semibold text-lg">Healthy Food Choices</p>
                            <p class="text-sm text-gray-500">+5 Points</p>
                        </div>
                    </div>
                    <button id="check-snack"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>
            </div>
        </div>

        
        <div id="message-container" class="modal-overlay hidden">
            <div id="message-box" class="modal-content max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300">
                <h3 id="message-title" class="text-3xl font-extrabold mb-3 text-teal-600">Well Done!</h3>
                <p id="message-text" class="text-gray-700 mb-6"></p>
                <button id="close-message"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                    Got it!
                </button>
            </div>
        </div>

        
        <div id="hero-name-modal" class="modal-overlay hidden">
            <div id="hero-name-box" class="modal-content max-w-md w-full text-center">
                <h2 class="text-3xl font-extrabold text-indigo-600 mb-2">Welcome, New Hero!</h2>
                <p class="text-gray-600 mb-6">Please enter your unique Hero Name to save your progress permanently.</p>
                
                <input type="text" id="hero-name-input" placeholder="e.g., John321"
                       class="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-2">
                
                <p class="text-sm text-gray-600 mb-6">
                    <span class="font-bold text-red-500">Tip:</span> Use letters and numbers for a unique name (e.g., John321) to ensure your profile loads correctly every time.
                </p>

                <button id="start-journey-btn"
                        class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition shadow-lg">
                    Start My Journey
                </button>
            </div>
        </div>

        <!-- NEW HISTORY EDIT MODAL -->
        <div id="history-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold mb-4 text-gray-800" id="history-modal-title">Edit History</h3>
                <p class="text-sm text-gray-500 mb-4" id="history-modal-date"></p>

                <div class="space-y-4">
                    <!-- Workout Toggle -->
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                        <label class="text-md font-semibold text-gray-700">üí™ Workout</label>
                        <div id="history-toggle-workout" class="toggle-switch"></div>
                    </div>
                    <!-- Snack Toggle -->
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                        <label class="text-md font-semibold text-gray-700">üçé Healthy Food Choices</label>
                        <div id="history-toggle-snack" class="toggle-switch"></div>
                    </div>
                </div>

                <div class="flex space-x-3 mt-6">
                    <button id="history-save-btn"
                            class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                        Save Changes
                    </button>
                    <button id="history-cancel-btn"
                            class="py-3 px-5 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        <!-- END NEW HISTORY EDIT MODAL -->

        
        <div class="mt-4 text-center text-xs text-gray-400">
            <p id="auth-status">Initializing Database...</p>
        </div>
    </div>

    
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

/* ------------------------------
    Firebase Configuration (Corrected Project ID)
-------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyANdoLSgsq0eXCOtRkVZsL9TZ4aaeIf-C8",
  authDomain: "hero-habit-tracker.firebaseapp.com", 
  projectId: "hero-habit-tracker", 
  storageBucket: "hero-habit-tracker.firebasestorage.app", 
  messagingSenderId: "972378549937",
  appId: "1:972378549937:web:1488d67ade251918b14af9",
  measurementId: "G-98P14X7MZZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ------------------------------
    App-ID (matches your rules)
-------------------------------- */
const appId = "__app_id" in window ? window.__app_id : "default";
const PROFILE_COLLECTION = `artifacts/${appId}/public/data/hero_profiles`;

/* ------------------------------
    App State
-------------------------------- */
let heroProfile = null;
let heroName = localStorage.getItem("heroName") || null;
const DB_TIMEOUT_MS = 5000;
let currentEditingDate = null; // New state for history editing


/* ------------------------------
    Badge Definitions
-------------------------------- */

function getLevel(points) {
    if (points < 50) return 1;
    return Math.floor(points / 50) + 1;
}

const BADGES = {
    'starter_star': {
        name: "Starter Star",
        description: "Earn 50 Total Points.",
        criteria: (data) => data.points >= 50,
        icon: '‚≠êÔ∏è'
    },
    'level_climber': {
        name: "Level Climber",
        description: "Reach Level 5.",
        criteria: (data) => getLevel(data.points) >= 5,
        icon: '‚¨ÜÔ∏è'
    },
    'hiit_master': {
        name: "HIIT Master",
        description: "Complete 10 Workouts.",
        criteria: (data) => data.workoutCount >= 10,
        icon: 'üèãÔ∏è'
    },
    'marathoner': {
        name: "Marathoner",
        description: "Complete 50 Workouts.",
        criteria: (data) => data.workoutCount >= 50,
        icon: 'üèÉ‚Äç‚ôÇÔ∏è'
    },
    'clean_eater': {
        name: "Clean Eater",
        description: "Log 10 Healthy Food Choices.",
        criteria: (data) => data.snackCount >= 10,
        icon: 'ü•ó'
    },
    'food_journaler': {
        name: "Food Journaler",
        description: "Log 100 Healthy Food Choices.",
        criteria: (data) => data.snackCount >= 100,
        icon: 'üìö'
    },
    'baby_streak': {
        name: "Baby Streak",
        description: "Hit a 3-day completion streak.",
        criteria: (data) => data.streak >= 3,
        icon: 'ü•â'
    },
    'weekly_warrior': {
        name: "Weekly Warrior",
        description: "Hit a 7-day completion streak.",
        criteria: (data) => data.streak >= 7,
        icon: 'ü•à'
    },
    'monthly_master': {
        name: "Monthly Master",
        description: "Hit a 30-day completion streak.",
        criteria: (data) => data.streak >= 30,
        icon: 'ü•á'
    }
};


/* ------------------------------
    Utility Functions
-------------------------------- */
function showMessage(title, message) {
    const container = document.getElementById('message-container');
    const box = document.getElementById('message-box');
    document.getElementById('message-title').textContent = title;
    document.getElementById('message-text').innerHTML = message;
    container.classList.remove('hidden');
    container.classList.add('flex');
    setTimeout(() => {
        box.classList.remove('scale-95', 'opacity-0');
        box.classList.add('scale-100', 'opacity-100');
    }, 10);
}
function hideMessage() {
    const container = document.getElementById('message-container');
    const box = document.getElementById('message-box');
    box.classList.remove('scale-100', 'opacity-100');
    box.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        container.classList.add('hidden');
        container.classList.remove('flex');
    }, 300);
}
document.getElementById('close-message').onclick = hideMessage;

function getTodayDateString() { return new Date().toISOString().slice(0, 10); }
function sanitizeName(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
}


/* ------------------------------
    Firestore: Load Profile (with Timeout and Error Handling)
-------------------------------- */
async function loadProfile(name) {
    try {
        const id = sanitizeName(name);
        const ref = doc(db, PROFILE_COLLECTION, id);
        
        // Use Promise.race for the timeout
        const dbFetchPromise = getDoc(ref);
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('DB_TIMEOUT')), DB_TIMEOUT_MS)
        );
        
        const snap = await Promise.race([dbFetchPromise, timeoutPromise]);

        document.getElementById("auth-status").innerText = "Database Status: Connected";
        if (snap.exists()) return snap.data();
        return null;

    } catch (error) {
        if (error.message === 'DB_TIMEOUT') {
             console.error("Profile load failed: DB Timeout");
             document.getElementById("auth-status").innerText = "Database Status: Timeout (Offline/Slow)";
             showMessage("Connection Error", "Database loading timed out. Check your connection.");
        } else {
             // Logs permission error which means connection was blocked externally
             console.error("Failed to load profile from Firestore:", error.message);
             document.getElementById("auth-status").innerText = "Database Status: Failed (Blocked)";
             showMessage("Connection Blocked", `Error: <code>${error.message}</code>. **Please check GCP API restrictions.**`);
        }
        return null; 
    }
}

/* ------------------------------
    Firestore: Save Profile
-------------------------------- */
async function saveProfile() {
    if (!heroProfile || !heroProfile.heroName) return;

    try {
        // Ensure new properties (like counts/badges) exist before merging
        heroProfile.workoutCount = heroProfile.workoutCount || 0;
        heroProfile.snackCount = heroProfile.snackCount || 0;
        heroProfile.earnedBadges = heroProfile.earnedBadges || {};
        
        const id = sanitizeName(heroProfile.heroName);
        const ref = doc(db, PROFILE_COLLECTION, id);
        await setDoc(ref, heroProfile, { merge: true });
    } catch (error) {
        console.error("Failed to save profile to Firestore:", error);
        showMessage("Save Error", `Your progress could not be saved to the cloud. Error: <code>${error.message}</code>`);
    }
}

/* ------------------------------
    Create New Profile Defaults
-------------------------------- */
function createNewProfile(name) {
  return {
    heroName: name,
    createdAt: Date.now(),
    lastCheckIn: null,
    streak: 0,
    workoutCount: 0,
    snackCount: 0,
    points: 0,
    level: 1,
    earnedBadges: {},
    cheatMealsEarned: 0,
    progress: []
  };
}

/* ------------------------------
    Badge Logic
-------------------------------- */

function checkForBadges() {
    let newBadgesEarned = false;

    Object.keys(BADGES).forEach(key => {
        const badge = BADGES[key];
        // Check if the badge is NOT already earned AND the criteria is met
        if (!heroProfile.earnedBadges[key] && badge.criteria(heroProfile)) {
            heroProfile.earnedBadges[key] = true;
            newBadgesEarned = true;
            showMessage("Badge Unlocked! üèÖ", `You earned the **${badge.name}** badge! Keep up the amazing work!`);
            console.log(`Badge unlocked: ${badge.name}`);
        }
    });
    return newBadgesEarned;
}

function renderBadges() {
    const container = document.getElementById('badges-container');
    container.innerHTML = ''; 

    if (!heroProfile || !heroProfile.earnedBadges) return;

    Object.keys(BADGES).forEach(key => {
        const badge = BADGES[key];
        const isEarned = heroProfile.earnedBadges[key] === true;

        const badgeHtml = `
            <div class="text-center p-2 rounded-lg" title="${badge.description}">
                <span class="text-5xl badge-icon ${isEarned ? 'earned' : ''}">${badge.icon}</span>
                <p class="text-xs font-semibold mt-1 ${isEarned ? 'text-teal-700' : 'text-gray-500'}">${badge.name}</p>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', badgeHtml);
    });
}

/* ------------------------------
    Streak Logic
-------------------------------- */

function checkStreakContinuity() {
    const lastCheckIn = heroProfile.lastCheckIn;

    if (!lastCheckIn) {
        // First time user starts the app, streak is 0.
        heroProfile.streak = 0;
        return;
    }

    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    const isLastDateToday = new Date(lastCheckIn).toDateString() === today.toDateString();
    
    // Check if the last check-in was yesterday
    const isConsecutive = new Date(lastCheckIn).toDateString() === yesterday.toDateString();

    if (!isLastDateToday && !isConsecutive && heroProfile.streak > 0) {
        // Streak broken
        showMessage("Streak Broken üòî", `Your streak of ${heroProfile.streak} days ended! Don't worry, start a new one today!`);
        heroProfile.streak = 0;
        return true;
    }
    return false;
}

function updateStreak(todayDateString) {
    const today = new Date().toDateString();
    
    // Check if yesterday's full completion was achieved to maintain the streak
    const progressToday = heroProfile.progress.filter(p => p.date === today);
    const didCompleteWorkout = progressToday.some(p => p.action === 'workout');
    const didCompleteSnack = progressToday.some(p => p.action === 'snack');

    // Only update streak if BOTH are complete
    if (didCompleteWorkout && didCompleteSnack) {
        const lastCheckIn = heroProfile.lastCheckIn;
        const lastCheckInDateString = lastCheckIn ? new Date(lastCheckIn).toDateString() : null;
        
        const isAlreadyUpdatedToday = lastCheckInDateString === today;
        
        if (isAlreadyUpdatedToday) {
            // Streak already updated today
            return; 
        }

        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayDateString = yesterday.toDateString();

        if (lastCheckInDateString === yesterdayDateString) {
            // Consecutive day completion! Increment streak.
            heroProfile.streak = (heroProfile.streak || 0) + 1;
            showMessage("Streak Progress! üî•", `You hit all your goals! Your streak is now ${heroProfile.streak} days!`);
        } else if (!lastCheckIn) {
            // First ever completion
            heroProfile.streak = 1;
            showMessage("Streak Started! üéâ", `You hit all your goals and started a 1-day streak!`);
        } else {
            // Completion, but not consecutive (Start a new streak of 1)
             if (heroProfile.streak === 0) {
                 heroProfile.streak = 1;
             }
        }
        
        // Update last check-in date ONLY when full completion is reached
        heroProfile.lastCheckIn = today;
    }
}

/* ------------------------------
    Daily Completion Status & Lockout
-------------------------------- */
function getDailyStatus() {
    if (!heroProfile) return { workout: false, snack: false };
    const today = new Date().toDateString();
    const progressToday = heroProfile.progress.filter(p => p.date === today);
    
    return {
        workout: progressToday.some(p => p.action === 'workout'),
        snack: progressToday.some(p => p.action === 'snack')
    };
}

function renderCheckInButtons() {
    const status = getDailyStatus();
    const workoutBtn = document.getElementById('check-workout');
    const snackBtn = document.getElementById('check-snack');

    const updateButton = (btn, isDone) => {
        if (isDone) {
            btn.classList.add('checked');
            btn.classList.remove('not-checked');
            btn.textContent = 'Completed!';
            btn.disabled = true;
        } else {
            btn.classList.remove('checked');
            btn.classList.add('not-checked');
            btn.textContent = 'Check In';
            btn.disabled = false;
        }
    };

    updateButton(workoutBtn, status.workout);
    updateButton(snackBtn, status.snack);
}

/* ------------------------------
    History Editing Functions
-------------------------------- */

function getDayStatusFromProfile(dateString) {
    const progressForDay = heroProfile.progress.filter(p => p.date === dateString);
    return {
        workout: progressForDay.some(p => p.action === 'workout'),
        snack: progressForDay.some(p => p.action === 'snack'),
        workoutIndex: progressForDay.findIndex(p => p.action === 'workout'),
        snackIndex: progressForDay.findIndex(p => p.action === 'snack'),
    };
}

function updateProfilePointsAndCounts(oldStatus, newStatus) {
    let pointsChange = 0;
    let workoutChange = 0;
    let snackChange = 0;

    // Calculate Workout changes
    if (!oldStatus.workout && newStatus.workout) { // Added
        pointsChange += 10;
        workoutChange += 1;
    } else if (oldStatus.workout && !newStatus.workout) { // Removed
        pointsChange -= 10;
        workoutChange -= 1;
    }

    // Calculate Snack changes
    if (!oldStatus.snack && newStatus.snack) { // Added
        pointsChange += 5;
        snackChange += 1;
    } else if (oldStatus.snack && !newStatus.snack) { // Removed
        pointsChange -= 5;
        snackChange -= 1;
    }

    // Apply changes to profile stats
    heroProfile.points += pointsChange;
    heroProfile.workoutCount += workoutChange;
    heroProfile.snackCount += snackChange;

    // Recalculate Cheat Meal Tokens
    const oldCheatMeals = Math.floor((heroProfile.snackCount - snackChange) / 5);
    const newCheatMeals = Math.floor(heroProfile.snackCount / 5);
    heroProfile.cheatMealsEarned += (newCheatMeals - oldCheatMeals);
    
    // Streak logic is complex for retrospective edits and is usually handled externally
    // However, we must ensure the points/counts are accurate.
}


function showHistoryModal(dateString) {
    const todayDate = new Date().toDateString();
    const selectedDate = new Date(dateString).toDateString();
    
    if (selectedDate === todayDate) {
        showMessage("Cannot Edit Today", "Please use the Check In buttons above for today's goals.");
        return;
    }

    // Lock future dates
    if (new Date(dateString) > new Date(todayDate)) {
        showMessage("Future Date", "You cannot edit future entries yet.");
        return;
    }

    currentEditingDate = dateString;
    const status = getDayStatusFromProfile(dateString);

    document.getElementById('history-modal-title').textContent = "Edit Journal Entry";
    document.getElementById('history-modal-date').textContent = `Date: ${selectedDate}`;

    const workoutToggle = document.getElementById('history-toggle-workout');
    const snackToggle = document.getElementById('history-toggle-snack');

    // Reset toggles
    workoutToggle.className = status.workout ? 'toggle-switch checked' : 'toggle-switch';
    snackToggle.className = status.snack ? 'toggle-switch checked' : 'toggle-switch';

    // Add click listeners to toggle switches
    workoutToggle.onclick = () => workoutToggle.classList.toggle('checked');
    snackToggle.onclick = () => snackToggle.classList.toggle('checked');

    document.getElementById('history-modal').classList.remove('hidden');
}

document.getElementById('history-cancel-btn').onclick = () => {
    document.getElementById('history-modal').classList.add('hidden');
    currentEditingDate = null;
};


document.getElementById('history-save-btn').onclick = async () => {
    if (!currentEditingDate || !heroProfile) return;

    const oldStatus = getDayStatusFromProfile(currentEditingDate);
    const newStatus = {
        workout: document.getElementById('history-toggle-workout').classList.contains('checked'),
        snack: document.getElementById('history-toggle-snack').classList.contains('checked')
    };

    if (oldStatus.workout === newStatus.workout && oldStatus.snack === newStatus.snack) {
        document.getElementById('history-modal').classList.add('hidden');
        currentEditingDate = null;
        return;
    }

    // 1. Update Core Stats (Points, Counts, Tokens)
    updateProfilePointsAndCounts(oldStatus, newStatus);
    
    // 2. Modify Progress Array
    const originalProgress = heroProfile.progress.filter(p => p.date !== currentEditingDate);
    
    if (newStatus.workout) {
        originalProgress.push({ date: currentEditingDate, action: 'workout' });
    }
    if (newStatus.snack) {
        originalProgress.push({ date: currentEditingDate, action: 'snack' });
    }
    heroProfile.progress = originalProgress;
    
    // 3. Re-run necessary checks
    checkForBadges();

    // 4. Save and Render
    await saveProfile();
    document.getElementById('history-modal').classList.add('hidden');
    
    // --- FIX APPLIED HERE ---
    const dateToDisplay = currentEditingDate; // Capture the correct date string
    currentEditingDate = null; // Reset the variable
    
    renderUI();
    // Use the captured date string in the message
    showMessage("History Updated!", `The entry for ${dateToDisplay} has been updated.`);
};


/* ------------------------------
    Initialize Hero Profile (Loads/Creates data)
-------------------------------- */
async function initProfile() {
  if (heroName) {
    heroProfile = await loadProfile(heroName);

    if (!heroProfile) {
      heroProfile = createNewProfile(heroName);
      await saveProfile(); 
    }

    // Ensure all necessary fields exist after loading old data
    heroProfile.earnedBadges = heroProfile.earnedBadges || {};
    heroProfile.workoutCount = heroProfile.workoutCount || 0;
    heroProfile.snackCount = heroProfile.snackCount || 0;
    heroProfile.cheatMealsEarned = heroProfile.cheatMealsEarned || 0;
    heroProfile.streak = heroProfile.streak || 0; 
    
    checkStreakContinuity(); // Check if streak was broken overnight

    checkForBadges();
    renderUI();
    return;
  }

  // Show name modal if no local name exists
  document.getElementById("hero-name-modal").classList.add("flex");
  document.getElementById("hero-name-modal").style.display = "flex";
}

/* ------------------------------
    Handle Name Submission (ASYNCHRONOUS processing)
-------------------------------- */
async function processProfileSetup(name) {
    const startJourneyBtn = document.getElementById("start-journey-btn");

    // REDUNDANCY FIX: Added safeguard to ensure modal is hidden instantly
    document.getElementById("hero-name-modal").style.display = "none";
    document.getElementById("hero-name-modal").classList.remove("flex");

    heroProfile = await loadProfile(name);

    if (!heroProfile) {
        heroProfile = createNewProfile(name);
        await saveProfile(); 
    } else {
        await saveProfile(); 
    }
    
    startJourneyBtn.disabled = false;
    checkForBadges();
    renderUI();
}

document.getElementById("start-journey-btn").onclick = (e) => {
    e.preventDefault();
    const raw = document.getElementById("hero-name-input").value.trim();
    const startJourneyBtn = e.target;

    if (raw.length < 3) {
        showMessage("Name Required", "Name must be at least 3 characters.");
        return;
    }

    // 1. INSTANTANEOUS SYNCHRONOUS UI UPDATE
    startJourneyBtn.disabled = true;
    heroName = raw;
    localStorage.setItem("heroName", heroName);
    
    // FIX: Hide the modal using inline style and class simultaneously for maximum browser compliance
    document.getElementById("hero-name-modal").style.display = "none";
    document.getElementById("hero-name-modal").classList.remove("flex");

    // 2. DELEGATE ASYNCHRONOUS DATA LOADING (guaranteed execution after repaint)
    // Using 50ms delay to force browser repaints before starting slow network process
    setTimeout(() => {
        processProfileSetup(raw);
    }, 50); 
};


/* ------------------------------
    Check-In Logic (Workout)
-------------------------------- */
document.getElementById("check-workout").onclick = async () => {
    if (!heroProfile) return; 
    
    const today = new Date().toDateString();

    const alreadyChecked = heroProfile.progress.find(p => p.date === today && p.action === 'workout');
    
    if (alreadyChecked) {
        showMessage("Already Done!", "You already completed your Workout today.");
        return;
    }

    heroProfile.progress.push({ date: today, action: 'workout' }); // Use 'workout' action key
    
    // Update Stats
    heroProfile.workoutCount = (heroProfile.workoutCount || 0) + 1;
    heroProfile.points = (heroProfile.points || 0) + 10;
    
    checkForBadges(); 
    
    // Check if this action completes the daily goal to update the streak
    const didCompleteSnack = getDailyStatus().snack;
    if (didCompleteSnack) {
        updateStreak(today);
    }
    
    await saveProfile();
    renderUI();
    showMessage("Workout Logged!", "Workout complete! +10 Points.");
};

/* ------------------------------
    Snack (Healthy Food Choices)
-------------------------------- */
document.getElementById("check-snack").onclick = async () => {
    if (!heroProfile) return; 

    const today = new Date().toDateString();

    const alreadyChecked = heroProfile.progress.find(p => p.date === today && p.action === 'snack');
    
    if (alreadyChecked) {
        showMessage("Already Done!", "You already logged your Healthy Food Choices today.");
        return;
    }

    heroProfile.progress.push({ date: today, action: 'snack' }); // Use 'snack' action key
    
    // Update Stats
    heroProfile.snackCount = (heroProfile.snackCount || 0) + 1;
    heroProfile.points = (heroProfile.points || 0) + 5;
    
    // Cheat Meal Reward Check
    if (heroProfile.snackCount % 5 === 0) {
        heroProfile.cheatMealsEarned = (heroProfile.cheatMealsEarned || 0) + 1;
        showMessage("Cheat Meal Unlocked! üçï", `You earned a token! Total tokens: ${heroProfile.cheatMealsEarned}`);
    }
    
    checkForBadges(); 
    
    // Check if this action completes the daily goal to update the streak
    const didCompleteWorkout = getDailyStatus().workout;
    if (didCompleteWorkout) {
        updateStreak(today);
    }

    await saveProfile();
    renderUI();
    showMessage("Snack Logged!", "Healthy Food Choices complete! +5 Points.");
};

/* ------------------------------
    Claim Cheat Meal
-------------------------------- */
document.getElementById("use-cheat-meal").onclick = async () => {
    if (!heroProfile) return; 

    if ((heroProfile.cheatMealsEarned || 0) <= 0) {
        showMessage("No Tokens", "You need to earn a cheat meal token first!");
        return;
    }

    heroProfile.cheatMealsEarned -= 1;
    await saveProfile();
    renderUI();
    showMessage("Reward Claimed!", "Enjoy your well-deserved reward!");
};


/* ------------------------------
    Render UI
-------------------------------- */
function renderUI() {
  if (!heroProfile) return;
  
  document.getElementById("welcome-message").innerText = `Welcome, ${heroProfile.heroName}!`;
  
  document.getElementById("current-streak").innerText = heroProfile.streak || 0;
  document.getElementById("total-points").innerText = heroProfile.points || 0;
  document.getElementById("current-level").innerText = Math.floor((heroProfile.points || 0) / 50) + 1;
  document.getElementById("cheat-meals-earned").innerText = heroProfile.cheatMealsEarned || 0;
  
  const snacksCount = heroProfile.snackCount || 0;
  const snacksNeeded = 5 - (snacksCount % 5);
  document.getElementById("snacks-to-next-reward").innerText = snacksNeeded === 5 ? 5 : snacksNeeded;

  renderBadges(); 
  renderCheckInButtons(); 
  renderRoadmap();
  
  // RENDER PROGRESS BAR
  const currentLevel = getLevel(heroProfile.points);
  const pointsInCurrentLevel = (heroProfile.points || 0) % 50;
  const progressPercentage = (pointsInCurrentLevel / 50) * 100;
  
  document.getElementById('next-level-display').textContent = currentLevel + 1;
  document.getElementById('points-current-in-level').textContent = pointsInCurrentLevel;
  document.getElementById('level-progress-bar').style.width = `${progressPercentage}%`;
}

/* ------------------------------
    Roadmap Rendering + Scroll Fix
-------------------------------- */
function renderRoadmap() {
  const container = document.getElementById("roadmap-container");
  container.innerHTML = "";

  const days = 60;
  const today = new Date().toDateString();
  const progressByDate = {};
  
  (heroProfile.progress || []).forEach(p => {
    if (!progressByDate[p.date]) {
        progressByDate[p.date] = { workout: false, snack: false };
    }
    if (p.action === 'workout') progressByDate[p.date].workout = true;
    if (p.action === 'snack') progressByDate[p.date].snack = true;
  });

  for (let i = 0; i < days; i++) {
    const currentDate = new Date();
    currentDate.setDate(currentDate.getDate() - (days - 1 - i));
    const dateStr = currentDate.toDateString();

    const box = document.createElement("div");
    box.className = "day-stop-wrapper"; 
    
    const stop = document.createElement("div");
    stop.className = "day-stop";
    stop.title = dateStr;
    stop.dataset.date = dateStr; // Store the date for click handler
    
    // Add click handler for history editing
    if (dateStr !== new Date().toDateString()) {
        stop.onclick = () => showHistoryModal(dateStr);
    }
    

    const status = progressByDate[dateStr];
    
    if (status) {
        if (status.workout && status.snack) {
            stop.classList.add("completed"); 
        } else if (status.workout || status.snack) {
            stop.classList.add("partial"); 
        }
    }
    
    if (dateStr === today) {
      stop.classList.add("today");
    }

    box.appendChild(stop);
    container.appendChild(box);
  }

  const scrollContainer = container.parentElement;
  if (scrollContainer) {
      requestAnimationFrame(() => {
          scrollContainer.scroll({
              left: scrollContainer.scrollWidth,
              behavior: 'smooth'
          });
      });
  }
}

/* ------------------------------
    Start App
-------------------------------- */
window.onload = initProfile;
</script>
