<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Hero Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Lighter, modern background */
            color: #1f2937;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08); /* Stronger, softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s; /* Added subtle hover effect */
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .check-btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .checked {
            background-color: #10b981 !important; /* Teal for success */
            color: white !important;
            cursor: default !important;
            box-shadow: none;
        }
        .not-checked {
            background-color: #4f46e5; /* Indigo for primary action */
            color: white;
        }
        .not-checked:hover {
            opacity: 1;
            background-color: #6366f1; /* Lighter Indigo on hover */
            transform: translateY(-2px);
        }
        .badge-icon {
            filter: grayscale(100%);
            opacity: 0.4;
            transition: all 0.3s ease-in-out;
            cursor: default;
        }
        .badge-icon.earned {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
            text-shadow: 0 0 8px rgba(255, 204, 0, 0.7);
        }
        .cheat-meal-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f87171 !important;
        }

        /* Roadmap Styles */
        .roadmap-track {
            height: 4px;
            background: linear-gradient(90deg, #d1d5db 0%, #a1a1aa 100%); /* Subtle gradient background for the path */
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            right: 0;
            z-index: 0;
        }
        .day-stop-wrapper {
            position: relative;
            z-index: 10;
            padding: 0 4px;
        }
        .day-stop {
            min-width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #e5e7eb; /* Gray for incomplete/future/missed */
            transition: all 0.3s;
            flex-shrink: 0;
            border: 3px solid white; /* White border for lift effect */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .day-stop.completed {
            background-color: #0d9488; /* Teal for full completion */
        }
        .day-stop.partial {
            background-color: #f59e0b; /* Amber/Orange for partial completion */
        }
        .day-stop.today {
            border: 3px solid #3b82f6; /* Blue border for today */
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        /* Modal for Hero Name */
        #hero-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #hero-name-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-xl mx-auto">
        
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-2 text-gray-800 flex items-center justify-center">
            <span class="text-yellow-500 text-6xl mr-3 transform -translate-y-1">üëë</span>
            Habit Hero
            <span class="text-yellow-500 text-6xl ml-3 transform -translate-y-1">üëë</span>
        </h1>
        <p id="welcome-message" class="text-center text-gray-500 mb-8">Gamifying your consistency, one goal at a time.</p>

        
        <div id="stats-container" class="grid grid-cols-3 gap-4 mb-8">
            <div class="card text-center bg-yellow-50 shadow-md p-3">
                <p id="total-points" class="text-3xl font-extrabold text-yellow-600">0</p>
                <p class="text-xs font-semibold uppercase text-gray-600 mt-1">Points</p>
            </div>
            <div class="card text-center bg-indigo-50 shadow-md p-3">
                <p id="current-level" class="text-3xl font-extrabold text-indigo-600">1</p>
                <p class="text-xs font-semibold uppercase text-gray-600 mt-1">Level</p>
            </div>
            <div class="card text-center bg-red-50 shadow-md p-3">
                <p id="current-streak" class="text-3xl font-extrabold text-red-600">0</p>
                <p class="text-xs font-semibold uppercase text-gray-600 mt-1">Streak üî•</p>
            </div>
        </div>

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                <span class="mr-2 text-teal-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14V4a2 2 0 0 0-4 0v10a2 2 0 0 1-2 2v6l2-1 2 1 2-1 2 1V8a2 2 0 0 0-2-2z"/></svg>
                </span>
                Your Habit Journey üó∫Ô∏è
            </h2>
            <div class="overflow-x-scroll pb-4 relative">
                
                <div class="roadmap-track absolute"></div> 
                <div id="roadmap-container" class="flex items-center space-x-2 relative z-10">
                    
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center">A visual map of your year's consistency.</p>
        </div>
        
        
        <div class="card bg-purple-100 border-purple-300 border shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-purple-700 flex items-center">
                <span class="mr-2 text-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s2-4 5-4 5 4 5 4 2-4 5-4 5 4 5 4M4 17h16"/></svg>
                </span>
                Cheat Meal Rewards üçï
            </h2>
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-700 text-lg font-semibold">Earned Tokens:</p>
                    <p id="cheat-meals-earned" class="text-5xl font-extrabold text-purple-600 mt-1">0</p>
                    <p class="text-xs text-gray-500 mt-2">Next token in <span id="snacks-to-next-reward">5</span> snacks.</p>
                </div>
                <button id="use-cheat-meal" disabled
                        class="cheat-meal-btn px-6 py-3 bg-red-600 text-white font-bold rounded-full text-base hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400 shadow-md transition duration-150 ease-in-out">
                    Claim Reward!
                </button>
            </div>
        </div>


        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                <span class="mr-2 text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15 6L19 7L16 11L17 15L12 13L7 15L8 11L5 7L9 6L12 2z"/></svg>
                </span>
                Achievements üèÖ
            </h2>
            <div id="badges-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-2 justify-items-center">
                
            </div>
        </div>

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Today's Focus</h2>
            <div class="space-y-4">
                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-indigo-600">üí™</span>
                        <div>
                            <p class="font-semibold text-lg">HIIT Workout</p>
                            <p class="text-sm text-gray-500">+10 Points</p>
                        </div>
                    </div>
                    <button id="check-workout"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>

                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-teal-600">üçé</span>
                        <div>
                            <p class="font-semibold text-lg">Healthy Snack</p>
                            <p class="text-sm text-gray-500">+5 Points</p>
                        </div>
                    </div>
                    <button id="check-snack"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>
            </div>
        </div>

        
        <div id="message-container" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 hidden z-50 justify-center items-center p-4">
            <div id="message-box" class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300">
                <h3 id="message-title" class="text-3xl font-extrabold mb-3 text-teal-600">Well Done!</h3>
                <p id="message-text" class="text-gray-700 mb-6"></p>
                <button id="close-message"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                    Got it!
                </button>
            </div>
        </div>

        
        <div id="hero-name-modal" class="hidden">
            <div id="hero-name-box" class="max-w-md w-full text-center">
                <h2 class="text-3xl font-extrabold text-indigo-600 mb-2">Welcome, New Hero!</h2>
                <p class="text-gray-600 mb-6">Please enter your unique Hero Name to save your progress permanently.</p>
                
                <input type="text" id="hero-name-input" placeholder="e.g., RuariFit24"
                       class="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-2">
                
                <p class="text-sm text-gray-600 mb-6">
                    <span class="font-bold text-red-500">Tip:</span> Use letters and numbers for a unique name (e.g., John321) to ensure your profile loads correctly every time.
                </p>

                <button id="start-journey-btn"
                        class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition shadow-lg">
                    Start My Journey
                </button>
            </div>
        </div>

        
        <div class="mt-4 text-center text-xs text-gray-400">
            <p id="auth-status">Initializing...</p>
        </div>
    </div>

    
    <script type="module">
        // --- PUBLIC FIREBASE CONFIGURATION ---
        // This object must be populated with your project's credentials for persistence to work.
        const MY_PUBLIC_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA49PvCa1rN1BoiJANFvCPbH7zkHEtvGWo",
            authDomain: "hero-habit-tracker.firebaseapp.com",
            projectId: "hero-habit-tracker",
            storageBucket: "hero-habit-tracker.firebasestorage.app",
            messagingSenderId: "32949342120",
            appId: "1:32949342120:web:79fc2cf241aefe13f0979d",
            measurementId: "G-67VDRZ783J"
        };
        // --- END PUBLIC FIREBASE CONFIGURATION ---

        // FIX: Removed the failing Firebase Auth imports and calls. We only need App and Firestore.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app;
        let db;
        // let auth; // No longer needed
        let heroName = null;
        let userRef = null;
        let userData = null;

        const USER_PROFILES_COLLECTION = `artifacts/${appId}/public/data/hero_profiles`;
        const SNACK_REWARD_THRESHOLD = 5;

        const POINTS = {
            WORKOUT: 10,
            SNACK: 5
        };

        const BADGES = {
            'starter_star': {
                name: "Starter Star", description: "Earn 50 Total Points.",
                criteria: (data) => data.points >= 50, icon: '‚≠êÔ∏è'
            },
            'hiit_master': {
                name: "HIIT Master", description: "Complete 10 HIIT Workouts.",
                criteria: (data) => data.workoutCount >= 10, icon: 'üèãÔ∏è'
            },
            'clean_eater': {
                name: "Clean Eater", description: "Log 10 Healthy Snacks.",
                criteria: (data) => data.snackCount >= 10, icon: 'ü•ó'
            },
            'baby_streak': {
                name: "Baby Streak", description: "Hit a 3-day completion streak.",
                criteria: (data) => data.currentStreak >= 3, icon: 'ü•â'
            },
            'weekly_warrior': {
                name: "Weekly Warrior", description: "Hit a 7-day completion streak.",
                criteria: (data) => data.currentStreak >= 7, icon: 'ü•à'
            },
            'monthly_master': {
                name: "Monthly Master", description: "Hit a 30-day completion streak.",
                criteria: (data) => data.currentStreak >= 30, icon: 'ü•á'
            },
            'level_climber': {
                name: "Level Climber", description: "Reach Level 5 (200 Total Points).",
                criteria: (data) => getLevel(data.points) >= 5, icon: '‚¨ÜÔ∏è'
            },
            'marathoner': {
                name: "Marathoner", description: "Complete 50 HIIT Workouts.",
                criteria: (data) => data.workoutCount >= 50, icon: 'üèÉ‚Äç‚ôÇÔ∏è'
            },
            'food_journaler': {
                name: "Food Journaler", description: "Log 100 Healthy Snacks.",
                criteria: (data) => data.snackCount >= 100, icon: 'üìö'
            }
        };

        // --- UTILITY FUNCTIONS ---
        function getTodayDateString() {
            return new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        }

        function isSameDay(date1, date2) {
            return date1.slice(0, 10) === date2.slice(0, 10);
        }

        function getDatesInRange(start, end) {
            const dateArray = [];
            let currentDate = new Date(start);
            while (currentDate <= end) {
                dateArray.push(currentDate.toISOString().slice(0, 10));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dateArray;
        }

        function getLevel(points) {
            if (points < 50) return 1;
            return Math.floor(points / 50) + 1;
        }

        function sanitizeName(name) {
            // Remove whitespace and convert to lowercase for document ID consistency
            return name.replace(/\s/g, '').toLowerCase();
        }

        // --- UI FUNCTIONS ---
        function showMessage(title, message) {
            const container = document.getElementById('message-container');
            const box = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').innerHTML = message;
            container.classList.remove('hidden');
            container.classList.add('flex');
            
            setTimeout(() => {
                box.classList.remove('scale-95', 'opacity-0');
                box.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideMessage() {
            const container = document.getElementById('message-container');
            const box = document.getElementById('message-box');
            
            box.classList.remove('scale-100', 'opacity-100');
            box.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                container.classList.add('hidden');
                container.classList.remove('flex');
            }, 300);
        }

        function showHeroNameModal() {
            document.getElementById('hero-name-modal').classList.remove('hidden');
        }

        function hideHeroNameModal() {
            document.getElementById('hero-name-modal').classList.add('hidden');
        }

        function renderBadges() {
            const container = document.getElementById('badges-container');
            container.innerHTML = '';

            if (!userData || !userData.earnedBadges) return;

            Object.keys(BADGES).forEach(key => {
                const badge = BADGES[key];
                const isEarned = userData.earnedBadges[key] === true;

                const badgeHtml = `
                    <div class="text-center p-2 rounded-lg" title="${badge.description}">
                        <span class="text-5xl badge-icon ${isEarned ? 'earned' : ''}">${badge.icon}</span>
                        <p class="text-xs font-semibold mt-1 ${isEarned ? 'text-teal-700' : 'text-gray-500'}">${badge.name}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', badgeHtml);
            });
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = '';

            if (!userData) return;

            const today = new Date();
            const todayStr = getTodayDateString();

            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 30); 

            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 335); 

            const dates = getDatesInRange(startDate, endDate);

            dates.forEach(dateStr => {
                const dailyStatus = userData.dailyStatus[dateStr];
                
                const isCompleted = dailyStatus && dailyStatus.workout && dailyStatus.snack;
                const isPartial = dailyStatus && (dailyStatus.workout || dailyStatus.snack) && !isCompleted;
                const isToday = dateStr === todayStr;

                let title = dateStr;
                let statusClass = '';

                if (isCompleted) {
                    title += " - Fully Completed! üéâ";
                    statusClass = 'completed';
                } else if (isPartial) {
                    title += " - Partial Progress üí™üçé";
                    statusClass = 'partial';
                } else if (isToday) {
                    title += " - Today's Goal";
                    statusClass = 'today';
                } else if (dateStr < todayStr) {
                    title += " - Missed Goal üôÅ";
                }
                
                const stopWrapper = document.createElement('div');
                stopWrapper.className = 'day-stop-wrapper'; 

                const stop = document.createElement('div');
                stop.className = `day-stop ${statusClass}`;
                stop.title = title;
                
                stopWrapper.appendChild(stop);
                container.appendChild(stopWrapper);
            });

            if (dates.length > 0) {
                const todayIndex = dates.findIndex(d => d === todayStr);
                if (todayIndex !== -1) {
                    setTimeout(() => {
                        const stopElement = container.children[todayIndex];
                        if (stopElement) {
                            const scrollPosition = stopElement.offsetLeft - (container.parentElement.offsetWidth / 2) + (stopElement.offsetWidth / 2);
                            container.parentElement.scrollLeft = scrollPosition;
                        }
                    }, 100);
                }
            }
        }


        function updateUI() {
            if (!userData) return;

            const today = getTodayDateString();
            const daily = userData.dailyStatus[today] || { workout: false, snack: false };

            document.getElementById('total-points').textContent = userData.points;
            document.getElementById('current-level').textContent = getLevel(userData.points);
            document.getElementById('current-streak').textContent = userData.currentStreak;
            
            // Welcome message update
            if (heroName) {
                document.getElementById('welcome-message').textContent = `Welcome back, ${heroName}!`;
            } else {
                 document.getElementById('welcome-message').textContent = `Gamifying your consistency, one goal at a time.`;
            }

            // Update Cheat Meal Tracker
            document.getElementById('cheat-meals-earned').textContent = userData.cheatMealsEarned;
            
            const snacksNeeded = SNACK_REWARD_THRESHOLD - (userData.snackCount % SNACK_REWARD_THRESHOLD);
            document.getElementById('snacks-to-next-reward').textContent = snacksNeeded === SNACK_REWARD_THRESHOLD ? SNACK_REWARD_THRESHOLD : snacksNeeded;

            const useCheatMealBtn = document.getElementById('use-cheat-meal');
            if (userData.cheatMealsEarned > 0) {
                useCheatMealBtn.disabled = false;
                useCheatMealBtn.classList.remove('bg-red-500');
                useCheatMealBtn.classList.add('bg-red-600', 'shadow-lg');
            } else {
                useCheatMealBtn.disabled = true;
                useCheatMealBtn.classList.remove('bg-red-600', 'shadow-lg');
                useCheatMealBtn.classList.add('bg-red-500');
            }

            renderBadges();
            renderRoadmap(); 

            const workoutBtn = document.getElementById('check-workout');
            const snackBtn = document.getElementById('check-snack');

            const updateButton = (btn, isDone) => {
                if (isDone) {
                    btn.classList.add('checked');
                    btn.classList.remove('not-checked');
                    btn.textContent = 'Completed!';
                    btn.disabled = true;
                } else {
                    btn.classList.remove('checked');
                    btn.classList.add('not-checked');
                    btn.textContent = 'Check In';
                    btn.disabled = false;
                }
            };

            updateButton(workoutBtn, daily.workout);
            updateButton(snackBtn, daily.snack);
        }

        // --- FIREBASE/CORE LOGIC ---

        function getInitialUserData(name) {
            const today = getTodayDateString();
            return {
                heroName: name,
                points: 0,
                currentStreak: 0,
                lastCompletionDate: today,
                workoutCount: 0,
                snackCount: 0,
                cheatMealsEarned: 0,
                earnedBadges: {},
                dailyStatus: {},
            };
        }

        async function fetchUserData(name) {
            // Must have db available for fetching
            if (!db) {
                userData = getInitialUserData(name);
                heroName = name;
                updateUI();
                showMessage("Database Warning", "Could not connect to the database. Progress will only be saved for this session.");
                return;
            }

            const sanitizedName = sanitizeName(name);
            userRef = doc(db, USER_PROFILES_COLLECTION, sanitizedName);
            
            try {
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    // Load existing data
                    userData = docSnap.data();
                    heroName = userData.heroName; // Load the properly cased name
                    console.log("Existing user data loaded:", userData);
                } else {
                    // Initialize new data
                    userData = getInitialUserData(name);
                    await setDoc(userRef, userData);
                    heroName = name;
                    showMessage("Welcome, New Hero!", `Your profile for **${heroName}** has been created! Click 'Check In' to start earning points.`);
                    console.log("New user profile created.");
                }

                checkAndResetStreak();
                checkForBadges(); 
                updateUI();
            } catch (error) {
                console.error("Error fetching or initializing user data:", error);
                // If fetching/saving fails (e.g., Firestore not set up), initialize data locally for the session
                userData = getInitialUserData(name);
                heroName = name;
                updateUI();
                showMessage("Database Warning", "Could not connect to the database. Progress will only be saved for this session.");
            }
        }

        function checkAndResetStreak() {
            const today = new Date();
            const todayStr = getTodayDateString();
            const lastDate = userData.lastCompletionDate;

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().slice(0, 10);

            // 1. Initialize today's status if missing
            if (!userData.dailyStatus[todayStr]) {
                userData.dailyStatus[todayStr] = { workout: false, snack: false, pointsEarned: 0 };
            }

            // 2. Check for streak break
            if (lastDate && lastDate < yesterdayStr) {
                if (userData.currentStreak > 0) {
                    console.log(`Streak broken. Last check-in was ${lastDate}.`);
                    showMessage("Streak Broken üòî", `Your streak of ${userData.currentStreak} days ended. Don't worry, start a new one today!`);
                    userData.currentStreak = 0;
                }
            }
        }

        function checkForBadges() {
            let newBadgesEarned = false;

            Object.keys(BADGES).forEach(key => {
                const badge = BADGES[key];
                if (!userData.earnedBadges[key] && badge.criteria(userData)) {
                    userData.earnedBadges[key] = true;
                    newBadgesEarned = true;
                    showMessage("Badge Unlocked! üèÖ", `You earned the **${badge.name}** badge! Keep up the amazing work!`);
                    console.log(`Badge unlocked: ${badge.name}`);
                }
            });
            return newBadgesEarned;
        }

        async function saveUserData() {
            if (db && userRef) {
                 try {
                    await setDoc(userRef, userData);
                    return true;
                } catch (error) {
                    console.error("Error saving user data:", error);
                    showMessage("Save Error", "Could not save progress to the database. Progress is currently only temporary.");
                    return false;
                }
            } else {
                // Not connected to DB, but we still update local data.
                return true;
            }
        }

        async function useCheatMeal() {
            if (userData.cheatMealsEarned > 0) {
                userData.cheatMealsEarned--;
                
                const saved = await saveUserData();
                if (saved) {
                    showMessage("Reward Claimed! üòã", "Go enjoy your cheat meal! Your token has been used.");
                } else {
                    userData.cheatMealsEarned++; // Rollback on failure
                }
                updateUI();
            } else {
                showMessage("No Tokens", "You need to earn a cheat meal token first! Log more healthy snacks.");
            }
        }

        async function completeTask(task) {
            if (!heroName) {
                showHeroNameModal();
                return;
            }
            if (!userData) return; 

            const today = getTodayDateString();
            const pointsGained = POINTS[task];
            const taskKey = task.toLowerCase(); // 'workout' or 'snack'

            if (!userData.dailyStatus[today]) {
                userData.dailyStatus[today] = { workout: false, snack: false, pointsEarned: 0 };
            }

            if (userData.dailyStatus[today][taskKey]) {
                showMessage("Already Done!", `You've already completed the ${task} task today. Check back tomorrow!`);
                return;
            }

            // 1. Update points, status, and new task counts locally
            userData.points += pointsGained;
            userData.dailyStatus[today][taskKey] = true;
            userData.dailyStatus[today].pointsEarned += pointsGained;

            if (taskKey === 'workout') {
                userData.workoutCount++;
            } else if (taskKey === 'snack') {
                userData.snackCount++;
                
                if (userData.snackCount > 0 && userData.snackCount % SNACK_REWARD_THRESHOLD === 0) {
                    userData.cheatMealsEarned++;
                    showMessage("Cheat Meal Unlocked! üçï", `Congratulations! You've logged ${userData.snackCount} healthy snacks and earned a free pass for a cheat meal! Total tokens: ${userData.cheatMealsEarned}`);
                }
            }

            // 2. Check for Streak Update
            const isAllCompleted = userData.dailyStatus[today].workout && userData.dailyStatus[today].snack;

            if (isAllCompleted) {
                const lastDate = userData.lastCompletionDate;
                const todayObj = new Date(today);
                const lastDateObj = lastDate ? new Date(lastDate) : null;
                const oneDayInMs = 24 * 60 * 60 * 1000;

                let isConsecutive = false;
                if (lastDateObj) {
                    // Check if yesterday was the last day
                    isConsecutive = lastDateObj.getTime() === todayObj.getTime() - oneDayInMs;
                }

                if (isConsecutive) {
                    userData.currentStreak++;
                    showMessage("Streak Progress! üî•", `You hit all your goals! Your streak is now ${userData.currentStreak} days!`);
                } else if (!isSameDay(lastDate, today)) {
                    userData.currentStreak = 1;
                    showMessage("Streak Started! üéâ", `You hit all your goals and started a 1-day streak!`);
                }
                
                userData.lastCompletionDate = today;
            } else {
                 showMessage("Points Gained!", `You earned ${pointsGained} points! Only one more task left to maintain your streak!`);
            }
            
            // 3. Check for badges
            checkForBadges();

            // 4. Update the UI and save to the database asynchronously
            updateUI();
            await saveUserData();
            console.log(`Task ${task} completed. Points: ${userData.points}. Streak: ${userData.currentStreak}`);
        }

        // --- NAME-BASED LOGIN LOGIC ---
        async function setHeroName(e) {
            e.preventDefault();
            const input = document.getElementById('hero-name-input');
            const name = input.value.trim();

            if (name.length < 2) {
                showMessage("Name Required", "Please enter a valid Hero Name to begin your journey.");
                return;
            }
            
            // 1. Immediately update UI to show responsiveness
            heroName = name;
            hideHeroNameModal();
            document.getElementById('welcome-message').textContent = `Loading profile for ${heroName}...`;

            // 2. Load the profile associated with this name (or create it)
            await fetchUserData(name);
        }
        
        // --- INITIALIZATION ---
        async function initializeFirebase() {
            const firebaseConfig = MY_PUBLIC_FIREBASE_CONFIG;
            const isConfigMissing = Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey;

            if (isConfigMissing) {
                console.warn("Warning: Firebase config missing. Data will not save permanently.");
                document.getElementById('auth-status').textContent = 'Warning: Firebase config missing. Data will not save permanently.';
                // If config is missing, just show the login modal and let the user proceed with local-only tracking.
                showHeroNameModal();
            } else {
                try {
                    // FIX: We no longer rely on Auth, so we initialize App and Firestore only.
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    
                    document.getElementById('auth-status').textContent = `Database Status: Ready`;
                    
                    // Show the modal to prompt for the Hero Name, which then triggers data load.
                    showHeroNameModal();

                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    document.getElementById('auth-status').textContent = `Initialization Error: Check console.`;
                    showHeroNameModal();
                }
            }

            // 3. Attach Event Listeners (MUST be outside the conditional checks to ensure buttons work)
            document.getElementById('check-workout').addEventListener('click', () => completeTask('WORKOUT'));
            document.getElementById('check-snack').addEventListener('click', () => completeTask('SNACK'));
            document.getElementById('use-cheat-meal').addEventListener('click', useCheatMeal);
            document.getElementById('close-message').addEventListener('click', hideMessage);
            
            // Hero Name Modal Listeners
            const startJourneyBtn = document.getElementById('start-journey-btn');
            startJourneyBtn.addEventListener('click', setHeroName);
            document.getElementById('hero-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setHeroName(e);
                }
            });
        }

        initializeFirebase();
    </script>
</body>
</html>
