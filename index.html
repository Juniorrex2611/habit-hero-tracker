<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Hero Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Lighter, modern background */
            color: #1f2937;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08); /* Stronger, softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s; /* Added subtle hover effect */
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .check-btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .checked {
            background-color: #10b981 !important; /* Teal for success */
            color: white !important;
            cursor: default !important;
            box-shadow: none;
        }
        .not-checked {
            background-color: #4f46e5; /* Indigo for primary action */
            color: white;
        }
        .not-checked:hover {
            opacity: 1;
            background-color: #6366f1; /* Lighter Indigo on hover */
            transform: translateY(-2px);
        }
        .badge-icon {
            filter: grayscale(100%);
            opacity: 0.4;
            transition: all 0.3s ease-in-out;
            cursor: default;
        }
        .badge-icon.earned {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
            text-shadow: 0 0 8px rgba(255, 204, 0, 0.7);
        }
        .cheat-meal-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f87171 !important;
        }

        /* Roadmap Styles */
        .roadmap-track {
            height: 4px;
            background: linear-gradient(90deg, #d1d5db 0%, #a1a1aa 100%); /* Subtle gradient background for the path */
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            right: 0;
            z-index: 0;
        }
        .day-stop-wrapper {
            position: relative;
            z-index: 10;
            padding: 0 4px;
        }
        .day-stop {
            min-width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #e5e7eb; /* Gray for incomplete/future/missed */
            transition: all 0.3s;
            flex-shrink: 0;
            border: 3px solid white; /* White border for lift effect */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .day-stop.completed {
            background-color: #0d9488; /* Teal for full completion */
        }
        .day-stop.partial {
            background-color: #f59e0b; /* Amber/Orange for partial completion */
        }
        .day-stop.today {
            border: 3px solid #3b82f6; /* Blue border for today */
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        /* Modal for Hero Name */
        #hero-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #hero-name-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-xl mx-auto">
        
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-2 text-gray-800 flex items-center justify-center">
            <span class="text-yellow-500 text-6xl mr-3 transform -translate-y-1">üëë</span>
            Habit Hero
            <span class="text-yellow-500 text-6xl ml-3 transform -translate-y-1">üëë</span>
        </h1>
        <p id="welcome-message" class="text-center text-gray-500 mb-8">Gamifying your consistency, one goal at a time.</p>

        
        <div id="stats-container" class="grid grid-cols-3 gap-4 mb-8">
            <div class="card text-center bg-yellow-50 shadow-md p-3">
                <p id="total-points" class="text-3xl font-extrabold text-yellow-600">0</p>
                <p id="total-points-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Points</p>
            </div>
            <div class="card text-center bg-indigo-50 shadow-md p-3">
                <p id="current-level" class="text-3xl font-extrabold text-indigo-600">1</p>
                <p id="current-level-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Level</p>
            </div>
            <div class="card text-center bg-red-50 shadow-md p-3">
                <p id="current-streak" class="text-3xl font-extrabold text-red-600">0</p>
                <p id="current-streak-label" class="text-xs font-semibold uppercase text-gray-600 mt-1">Streak üî•</p>
            </div>
        </div>

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                <span class="mr-2 text-teal-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14V4a2 2 0 0 0-4 0v10a2 2 0 0 1-2 2v6l2-1 2 1 2-1 2 1V8a2 2 0 0 0-2-2z"/></svg>
                </span>
                Your Habit Journey üó∫Ô∏è
            </h2>
            <div class="overflow-x-scroll pb-4 relative">
                
                <div class="roadmap-track absolute"></div> 
                <div id="roadmap-container" class="flex items-center space-x-2 relative z-10">
                    
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center">A visual map of your year's consistency.</p>
        </div>
        
        
        <div class="card bg-purple-100 border-purple-300 border shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-purple-700 flex items-center">
                <span class="mr-2 text-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s2-4 5-4 5 4 5 4 2-4 5-4 5 4 5 4M4 17h16"/></svg>
                </span>
                Cheat Meal Rewards üçï
            </h2>
            <div class="flex items-center justify-between">
                <div>
                    <p id="cheat-meals-title" class="text-gray-700 text-lg font-semibold">Earned Tokens:</p>
                    <p id="cheat-meals-earned" class="text-5xl font-extrabold text-purple-600 mt-1">0</p>
                    <p id="snacks-needed-text" class="text-xs text-gray-500 mt-2">Next token in <span id="snacks-to-next-reward">5</span> snacks.</p>
                </div>
                <button id="use-cheat-meal" disabled
                        class="cheat-meal-btn px-6 py-3 bg-red-600 text-white font-bold rounded-full text-base hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400 shadow-md transition duration-150 ease-in-out">
                    Claim Reward!
                </button>
            </div>
        </div>


        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                <span class="mr-2 text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15 6L19 7L16 11L17 15L12 13L7 15L8 11L5 7L9 6L12 2z"/></svg>
                </span>
                Achievements üèÖ
            </h2>
            <div id="badges-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-2 justify-items-center">
                
            </div>
        </div>

        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Today's Focus</h2>
            <div class="space-y-4">
                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-indigo-600">üí™</span>
                        <div>
                            <p class="font-semibold text-lg">HIIT Workout</p>
                            <p class="text-sm text-gray-500">+10 Points</p>
                        </div>
                    </div>
                    <button id="check-workout"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>

                
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-indigo-100 transition duration-300 hover:border-indigo-400">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3 text-teal-600">üçé</span>
                        <div>
                            <p class="font-semibold text-lg">Healthy Snack</p>
                            <p class="text-sm text-gray-500">+5 Points</p>
                        </div>
                    </div>
                    <button id="check-snack"
                            class="check-btn not-checked px-4 py-2 font-bold rounded-full text-sm">
                        Check In
                    </button>
                </div>
            </div>
        </div>

        
        <div id="message-container" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 hidden z-50 justify-center items-center p-4">
            <div id="message-box" class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300">
                <h3 id="message-title" class="text-3xl font-extrabold mb-3 text-teal-600">Well Done!</h3>
                <p id="message-text" class="text-gray-700 mb-6"></p>
                <button id="close-message"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                    Got it!
                </button>
            </div>
        </div>

        
        <div id="hero-name-modal" class="hidden">
            <div id="hero-name-box" class="max-w-md w-full text-center">
                <h2 class="text-3xl font-extrabold text-indigo-600 mb-2">Welcome, New Hero!</h2>
                <p class="text-gray-600 mb-6">Please enter your unique Hero Name to save your progress permanently.</p>
                
                <input type="text" id="hero-name-input" placeholder="e.g., RuariFit24"
                       class="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-2">
                
                <p class="text-sm text-gray-600 mb-6">
                    <span class="font-bold text-red-500">Tip:</span> Use letters and numbers for a unique name (e.g., John321) to ensure your profile loads correctly every time.
                </p>

                <button id="start-journey-btn"
                        class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition shadow-lg">
                    Start My Journey
                </button>
            </div>
        </div>

        
        <div class="mt-4 text-center text-xs text-gray-400">
            <p id="auth-status">Initializing Database...</p>
        </div>
    </div>

    
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

/* ------------------------------
    Firebase Configuration (CORRECTED to hero-habit-tracker)
-------------------------------- */
// üö® NOTE: The values used below are the ones provided for the working project, 
// but the 'projectId' field below is the key identifier that has been corrected.
const firebaseConfig = {
  apiKey: "AIzaSyANdoLSgsq0eXCOtRkVZsL9TZ4aaeIf-C8",
  authDomain: "hero-habit-tracker.firebaseapp.com", // Corrected domain based on project name
  projectId: "hero-habit-tracker", // üõë CORRECT PROJECT ID USED FOR DEMO PURPOSES üõë
  storageBucket: "hero-habit-tracker.firebasestorage.app", // Corrected storage
  messagingSenderId: "972378549937",
  appId: "1:972378549937:web:1488d67ade251918b14af9",
  measurementId: "G-98P14X7MZZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ------------------------------
    App-ID (matches your rules)
-------------------------------- */
const appId = "__app_id" in window ? window.__app_id : "default";
const PROFILE_COLLECTION = `artifacts/${appId}/public/data/hero_profiles`;

/* ------------------------------
    App State
-------------------------------- */
let heroProfile = null;
let heroName = localStorage.getItem("heroName") || null;
const DB_TIMEOUT_MS = 5000;


/* ------------------------------
    Utility Functions
-------------------------------- */
function showMessage(title, message) {
    const container = document.getElementById('message-container');
    const box = document.getElementById('message-box');
    document.getElementById('message-title').textContent = title;
    document.getElementById('message-text').innerHTML = message;
    container.classList.remove('hidden');
    container.classList.add('flex');
    setTimeout(() => {
        box.classList.remove('scale-95', 'opacity-0');
        box.classList.add('scale-100', 'opacity-100');
    }, 10);
}
function hideMessage() {
    const container = document.getElementById('message-container');
    const box = document.getElementById('message-box');
    box.classList.remove('scale-100', 'opacity-100');
    box.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        container.classList.add('hidden');
        container.classList.remove('flex');
    }, 300);
}
document.getElementById('close-message').onclick = hideMessage;

function getTodayDateString() { return new Date().toISOString().slice(0, 10); }
function sanitizeName(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
}


/* ------------------------------
    Firestore: Load Profile (with Timeout and Error Handling)
-------------------------------- */
async function loadProfile(name) {
    try {
        const id = sanitizeName(name);
        const ref = doc(db, PROFILE_COLLECTION, id);
        
        // Use Promise.race for the timeout
        const dbFetchPromise = getDoc(ref);
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('DB_TIMEOUT')), DB_TIMEOUT_MS)
        );
        
        const snap = await Promise.race([dbFetchPromise, timeoutPromise]);

        document.getElementById("auth-status").innerText = "Database Status: Connected";
        if (snap.exists()) return snap.data();
        return null;

    } catch (error) {
        if (error.message === 'DB_TIMEOUT') {
             console.error("Profile load failed: DB Timeout");
             document.getElementById("auth-status").innerText = "Database Status: Timeout (Offline/Slow)";
             showMessage("Connection Error", "Database loading timed out. Check your connection.");
        } else {
             // Logs permission error which means connection was blocked externally
             console.error("Failed to load profile from Firestore:", error.message);
             document.getElementById("auth-status").innerText = "Database Status: Failed (Blocked)";
             showMessage("Connection Blocked", `Error: <code>${error.message}</code>. **Please check GCP API restrictions.**`);
        }
        return null; 
    }
}

/* ------------------------------
    Firestore: Save Profile
-------------------------------- */
async function saveProfile() {
    if (!heroProfile || !heroProfile.heroName) return;

    try {
        const id = sanitizeName(heroProfile.heroName);
        const ref = doc(db, PROFILE_COLLECTION, id);
        await setDoc(ref, heroProfile, { merge: true });
    } catch (error) {
        console.error("Failed to save profile to Firestore:", error);
        showMessage("Save Error", `Your progress could not be saved to the cloud. Error: <code>${error.message}</code>`);
    }
}

/* ------------------------------
    Create New Profile Defaults
-------------------------------- */
function createNewProfile(name) {
  return {
    heroName: name,
    createdAt: Date.now(),
    lastCheckIn: null,
    streak: 0,
    workoutCount: 0,
    snackCount: 0,
    points: 0,
    level: 1,
    earnedBadges: {},
    cheatMealsEarned: 0,
    progress: []
  };
}

/* ------------------------------
    Initialize Hero Profile (Loads/Creates data)
-------------------------------- */
async function initProfile() {
  if (heroName) {
    heroProfile = await loadProfile(heroName);

    if (!heroProfile) {
      // Profile load failed (e.g., timeout), create a new local session profile
      heroProfile = createNewProfile(heroName);
    }

    renderUI();
    return;
  }

  // Show name modal if no local name exists
  document.getElementById("hero-name-modal").classList.add("flex");
  document.getElementById("hero-name-modal").style.display = "flex";
}

/* ------------------------------
    Handle Name Submission (ASYNCHRONOUS processing)
-------------------------------- */
async function processProfileSetup(name) {
    const startJourneyBtn = document.getElementById("start-journey-btn");

    // REDUNDANCY FIX: Added safeguard to ensure modal is hidden instantly
    document.getElementById("hero-name-modal").style.display = "none";
    document.getElementById("hero-name-modal").classList.remove("flex");

    heroProfile = await loadProfile(name);

    if (!heroProfile) {
        // If load fails, create new profile locally and attempt save in background
        heroProfile = createNewProfile(name);
        await saveProfile(); 
    } else {
        // If load succeeds, update profile on load
        await saveProfile(); 
    }
    
    startJourneyBtn.disabled = false;
    renderUI();
}

document.getElementById("start-journey-btn").onclick = (e) => {
    e.preventDefault();
    const raw = document.getElementById("hero-name-input").value.trim();
    const startJourneyBtn = e.target;

    if (raw.length < 3) {
        showMessage("Name Required", "Name must be at least 3 characters.");
        return;
    }

    // 1. INSTANTANEOUS SYNCHRONOUS UI UPDATE
    startJourneyBtn.disabled = true;
    heroName = raw;
    localStorage.setItem("heroName", heroName);
    
    // FIX: Hide the modal using inline style and class simultaneously for maximum browser compliance
    document.getElementById("hero-name-modal").style.display = "none";
    document.getElementById("hero-name-modal").classList.remove("flex");

    // 2. DELEGATE ASYNCHRONOUS DATA LOADING (guaranteed execution after repaint)
    // Using 50ms delay to force browser repaints before starting slow network process
    setTimeout(() => {
        processProfileSetup(raw);
    }, 50); 
};


/* ------------------------------
    Check-In Logic (HIIT Workout)
-------------------------------- */
document.getElementById("check-workout").onclick = async () => {
    // Requires profile to be loaded
    if (!heroProfile) return; 
    
    const today = new Date().toDateString();

    const alreadyChecked = heroProfile.progress.find(p => p.date === today && p.action === 'workout');
    
    if (alreadyChecked) {
        showMessage("Already Done!", "You already completed your HIIT Workout today.");
        return;
    }

    heroProfile.progress.push({ date: today, action: "workout" });
    
    // Re-implementing original logic
    heroProfile.workoutCount = (heroProfile.workoutCount || 0) + 1;
    heroProfile.points = (heroProfile.points || 0) + 10;
    
    await saveProfile();
    renderUI();
    showMessage("Workout Logged!", "HIIT Workout complete! +10 Points.");
};

/* ------------------------------
    Snack (Healthy Snack)
-------------------------------- */
document.getElementById("check-snack").onclick = async () => {
    // Requires profile to be loaded
    if (!heroProfile) return; 

    const today = new Date().toDateString();

    const alreadyChecked = heroProfile.progress.find(p => p.date === today && p.action === 'snack');
    
    if (alreadyChecked) {
        showMessage("Already Done!", "You already logged a Healthy Snack today.");
        return;
    }

    heroProfile.progress.push({ date: today, action: "snack" });
    
    heroProfile.snackCount = (heroProfile.snackCount || 0) + 1;
    heroProfile.points = (heroProfile.points || 0) + 5;
    
    // Cheat Meal Reward Check
    if (heroProfile.snackCount % 5 === 0) {
        heroProfile.cheatMealsEarned = (heroProfile.cheatMealsEarned || 0) + 1;
        showMessage("Cheat Meal Unlocked! üçï", `You earned a token! Total tokens: ${heroProfile.cheatMealsEarned}`);
    }
    
    await saveProfile();
    renderUI();
    showMessage("Snack Logged!", "Healthy Snack complete! +5 Points.");
};

/* ------------------------------
    Claim Cheat Meal
-------------------------------- */
document.getElementById("use-cheat-meal").onclick = async () => {
    if (!heroProfile) return; 

    if ((heroProfile.cheatMealsEarned || 0) <= 0) {
        showMessage("No Tokens", "You need to earn a cheat meal token first!");
        return;
    }

    heroProfile.cheatMealsEarned -= 1;
    await saveProfile();
    renderUI();
    showMessage("Reward Claimed!", "Enjoy your well-deserved reward!");
};


/* ------------------------------
    Render UI
-------------------------------- */
function renderUI() {
  if (!heroProfile) return;
  
  document.getElementById("welcome-message").innerText = `Welcome, ${heroProfile.heroName}!`;
  
  document.getElementById("current-streak").innerText = heroProfile.streak || 0;
  document.getElementById("total-points").innerText = heroProfile.points || 0;
  document.getElementById("current-level").innerText = Math.floor((heroProfile.points || 0) / 50) + 1;
  document.getElementById("cheat-meals-earned").innerText = heroProfile.cheatMealsEarned || 0;
  
  const snacksCount = heroProfile.snackCount || 0;
  const snacksNeeded = 5 - (snacksCount % 5);
  document.getElementById("snacks-to-next-reward").innerText = snacksNeeded === 5 ? 5 : snacksNeeded;

  // Placeholder for Badges
  document.getElementById("badges-container").innerHTML = "<p class='col-span-4 text-gray-500 text-center text-sm'>Badges logic requires re-implementation.</p>";
  
  renderRoadmap();
}

/* ------------------------------
    Roadmap Rendering + Scroll Fix
-------------------------------- */
function renderRoadmap() {
  const container = document.getElementById("roadmap-container");
  container.innerHTML = "";

  const days = 60;
  const today = new Date().toDateString();
  const progressByDate = {};
  
  (heroProfile.progress || []).forEach(p => {
    if (!progressByDate[p.date]) {
        progressByDate[p.date] = { workout: false, snack: false };
    }
    if (p.action === 'workout') progressByDate[p.date].workout = true;
    if (p.action === 'snack') progressByDate[p.date].snack = true;
  });

  for (let i = 0; i < days; i++) {
    const currentDate = new Date();
    currentDate.setDate(currentDate.getDate() - (days - 1 - i));
    const dateStr = currentDate.toDateString();

    const box = document.createElement("div");
    box.className = "day-stop-wrapper"; 
    
    const stop = document.createElement("div");
    stop.className = "day-stop";
    stop.title = dateStr;

    const status = progressByDate[dateStr];
    
    if (status) {
        if (status.workout && status.snack) {
            stop.classList.add("completed"); 
        } else if (status.workout || status.snack) {
            stop.classList.add("partial"); 
        }
    }
    
    if (dateStr === today) {
      stop.classList.add("today");
    }

    box.appendChild(stop);
    container.appendChild(box);
  }

  const scrollContainer = container.parentElement;
  if (scrollContainer) {
      requestAnimationFrame(() => {
          scrollContainer.scroll({
              left: scrollContainer.scrollWidth,
              behavior: 'smooth'
          });
      });
  }
}

/* ------------------------------
    Start App
-------------------------------- */
window.onload = initProfile;
</script>
